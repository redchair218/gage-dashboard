<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Missouri Gauge Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 600px; position: relative; }

    #controls {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    #controls select,
    #controls button {
      font-size: 13px;
      padding: 2px 6px;
    }

    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      color: #333;
      border-radius: 4px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    .legend i {
      width: 12px;
      height: 12px;
      float: left;
      margin-right: 8px;
      opacity: 0.8;
    }

    .info-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      max-height: 150px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      background: rgba(255,255,255,0.95);
      border-top: 2px solid #ccc;
      font-size: 13px;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .info-bar h4 {
      margin: 0 0 8px;
    }

    .info-bar .gage-item {
      display: inline-block;
      margin-right: 16px;
      padding: 4px 8px;
      background: #f2f2f2;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .info-bar .gage-item:hover {
      background: #e0e0e0;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="controls">
  <label for="rfc-select">RFC:</label>
  <select id="rfc-select"><option value="">All</option></select>

  <label for="wfo-select">WFO:</label>
  <select id="wfo-select"><option value="">All</option></select>

  <label><input type="checkbox" id="include-non-forecast"> Include non-forecast</label>

  <button id="download-btn">Export CSV</button>
</div>

<div id="forecast-list" class="info-bar"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
<script>
const map = L.map('map').setView([38.5, -92.5], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

fetch('https://raw.githubusercontent.com/redchair218/RFC_SA_display/master/topojson/boundary_rfc.json')
  .then(res => res.json())
  .then(topology => {
    const geojson = topojson.feature(topology, topology.objects.boundary_rfc);
    L.geoJSON(geojson, {
      style: {
        color: 'black',
        weight: 2,
        fillOpacity: 0
      }
    }).addTo(map);
  });

const bbox = {
  xmin: -95.77,
  ymin: 35.99,
  xmax: -89.10,
  ymax: 40.61
};

const apiUrl = \`https://api.water.noaa.gov/nwps/v1/gauges?bbox.xmin=\${bbox.xmin}&bbox.ymin=\${bbox.ymin}&bbox.xmax=\${bbox.xmax}&bbox.ymax=\${bbox.ymax}&srid=EPSG_4326\`;

let allGauges = [];
let currentMarkers = [];

fetch(apiUrl)
  .then(res => res.json())
  .then(data => {
    const gauges = data.gauges || [];
    const rfcSet = new Set();
    const wfoSet = new Set();

    gauges.forEach(g => {
      if (g.state?.abbreviation !== "MO") return;
      const isForecast = g.pedts?.forecast && g.pedts.forecast !== "";
      rfcSet.add(g.rfc?.abbreviation || "Unknown");
      wfoSet.add(g.wfo?.abbreviation || "Unknown");

      allGauges.push({
        name: g.name,
        id: g.lid || g.usgsId,
        rfc: g.rfc?.abbreviation || "Unknown",
        wfo: g.wfo?.abbreviation || "Unknown",
        lat: g.latitude,
        lon: g.longitude,
        isForecast
      });
    });

    populateDropdown("rfc-select", rfcSet);
    populateDropdown("wfo-select", wfoSet);
    renderGauges();
  });

function populateDropdown(id, items) {
  const select = document.getElementById(id);
  Array.from(items).sort().forEach(value => {
    const opt = document.createElement("option");
    opt.value = value;
    opt.textContent = value;
    select.appendChild(opt);
  });
}

function renderGauges() {
  const rfcFilter = document.getElementById("rfc-select").value;
  const wfoFilter = document.getElementById("wfo-select").value;
  const includeNonForecast = document.getElementById("include-non-forecast").checked;

  const filtered = allGauges.filter(g =>
    (!rfcFilter || g.rfc === rfcFilter) &&
    (!wfoFilter || g.wfo === wfoFilter) &&
    (includeNonForecast || g.isForecast)
  );

  currentMarkers.forEach(m => map.removeLayer(m));
  currentMarkers = [];

  const container = document.getElementById("forecast-list");
  container.innerHTML = \`<h4>Gauges (\${filtered.length})</h4>\` +
    filtered.map((g, i) => \`<span class="gage-item" data-index="\${i}"><strong>\${g.name}</strong><br><small>\${g.id}</small></span>\`).join('');

  filtered.forEach(g => {
    const marker = L.circleMarker([g.lat, g.lon], {
      radius: 6,
      fillColor: g.isForecast ? 'green' : 'blue',
      color: "#000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(map);

    marker.bindPopup(\`<strong>\${g.name}</strong><br>\${g.id}<br>RFC: \${g.rfc} | WFO: \${g.wfo}<br>\${g.isForecast ? 'Forecast' : 'Non-Forecast'}\`);
    currentMarkers.push(marker);
  });

  document.querySelectorAll(".gage-item").forEach((el, i) => {
    el.addEventListener("click", () => {
      const g = filtered[i];
      map.flyTo([g.lat, g.lon], 12, { duration: 1.2 });
      currentMarkers[i].openPopup();
    });
  });

  document.getElementById("download-btn").onclick = () => exportToCSV(filtered);
}

function exportToCSV(data) {
  const rows = [["Name", "ID", "RFC", "WFO", "Latitude", "Longitude", "IsForecast"]];
  data.forEach(g => rows.push([g.name, g.id, g.rfc, g.wfo, g.lat, g.lon, g.isForecast ? "Yes" : "No"]));

  const csv = rows.map(r => r.map(val => \`"\${val}"\`).join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "missouri_gauges.csv";
  a.click();
}

document.getElementById("rfc-select").addEventListener("change", renderGauges);
document.getElementById("wfo-select").addEventListener("change", renderGauges);
document.getElementById("include-non-forecast").addEventListener("change", renderGauges);

const legendControl = L.control({ position: "topright" });
legendControl.onAdd = function () {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<i style='background: green'></i> Forecast Gauge<br>";
  div.innerHTML += "<i style='background: blue'></i> Non-Forecast Gauge<br>";
  return div;
};
legendControl.addTo(map);
</script>
</body>
</html>
